WORK IN PROGRESS

#summary Internal workings of the database.

= Introduction =

The BIMserver is storing all data in a key-value store, this key-value can be changed in code, but the only implementation right now is in the open source BerkeleyDB Java Edition (http://www.oracle.com/technetwork/database/berkeleydb/overview/index-093405.html).

A key value store is defined as:
* A set of named tables
* Each table has 2 columns, key and value
* Both the key and value column can contain an arbitrarily sized byte array, this size may vary per record
* All keys in a table are always ordered
* No duplicate keys can exist

= Principles =

* Models are stored in projects
* Each new version of the model is stored a new revision
* Each revision of the project should always be accessible
* Revisions, once stored, can never be changed
* Objects in a project can only reference other objects in the same project.

= Details =

Each record in a table has the following layout:

||Key||Value||
||Pid (4 bytes) + Oid (8 bytes) + Rid (4 bytes)||See description of value||

Pid = Project Id
Oid = Object Id
Rid = Revision Id

Record are only added, never modified or deleted.

= Value =

Please read this first: [Link to description of EMF]
For all structural features of the class of the object, some bytes are written to the value part of the record. All values are written in the order defined by the EMF model and include all structural features of all super classes.

Single attributes:

||Type||Size(bytes)||Serialisation||Null representation||
||String||2 + size of bytes||UTF-8 encoded||-1 (as a short)||
||Integer||4||Default java serialisation||Cannot be null||
||Long||8||Default java serialisation||Cannot be null||
||Float||4||Default java serialisation||Cannot be null||
||Double||8||Default java serialisation||Cannot be null||
||Boolean||1||0 for false, 1 for true||Cannot be null||
||Date||8||Time||Number of milliseconds since January 1, 1970, 00:00:00 GMT||-1 (as a long)||
||Tristate||1||0 for true, 1 for false, 2 for undefined||Cannot be null||
||ByteArray||4 + Length||4 bytes (int) for length + bytes||0 (as int)||
||Enum||4||Enum literal||Cannot be null||
||Reference||8||||-1 (as long)||

Single references:

Multiple attributes:

Multiple references: