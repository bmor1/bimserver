<project name="BIMserver Common">
	<tstamp>
		<format property="touch.time" pattern="yyyy-MM-dd'T'HH:mm:ss.S'+01:00'" />
	</tstamp>
	<target name="buildjar">
		<delete dir="builds" />
		<mkdir dir="builds" />
		<copy todir="builds/BuildJar">
			<fileset file="../deploy/shared/gpl.txt" />
		</copy>
		<copy todir="builds/BuildJar/www">
			<fileset dir="../www" />
		</copy>
		<copy todir="builds/BuildJar/config" overwrite="true">
			<fileset file="../deploy/shared/IFC2X3_FINAL.exp" />
			<fileset file="../deploy/shared/version.xml" />
			<fileset file="../deploy/shared/ignore.xml" />
			<fileset file="../deploy/shared/web.xml" />
			<fileset file="../deploy/shared/collada.xml" />
			<fileset file="../deploy/shared/_asCOBie2.xml.xsl" />
			<fileset file="../deploy/shared/_fromCOBie2.ifcxml.xsl" />
			<fileset file="../deploy/shared/_Report1.xhtml.xsl" />
			<fileset file="../${deploydir}/settings.xml" />
		</copy>
		<copy file="../deploy/jar/servertype.txt" todir="builds/BuildJar" />
		<copy todir="builds/BuildJar/www/META-INF" overwrite="true">
			<fileset file="../deploy/shared/context.xml" />
		</copy>
		<copy todir="builds/BuildJar/config/templates" overwrite="true" failonerror="false">
			<fileset dir="../${deploydir}/templates" />
		</copy>
		<copy todir="builds/BuildJar/www" overwrite="true" failonerror="false">
			<fileset dir="../${deploydir}/jsp" />
		</copy>
		<copy todir="builds/BuildJar/www/images" overwrite="true" failonerror="false">
			<fileset dir="../${deploydir}/images" />
		</copy>
		<copy todir="builds/BuildJar/config/ignoreexceptions" overwrite="true" failonerror="false">
			<fileset dir="../deploy/shared/ignoreexceptions" />
		</copy>
		<replace file="builds/BuildJar/config/version.xml" token="@VERSION@" value="${version}" />
		<replace file="builds/BuildJar/config/version.xml" token="@DATE@" value="${touch.time}" />
		<replace file="builds/BuildJar/config/web.xml" token="@VERSION@" value="${version}" />
		<copy todir="builds/BuildJar/lib">
			<fileset file="../${deploydir}/log4j.xml" />
		</copy>
		<copy tofile="builds/BuildJar/classes/org/bimserver/ifc/emf/Ifc2x3/impl/Ifc2x3.ecore">
			<fileset file="../../Ifc/model/IFC2X3.ecore" />
		</copy>
		<copy todir="builds/BuildJar/lib" flatten="true">
			<fileset dir="../lib" >
				<include name="**/*.jar" />
			</fileset>
			<fileset dir="../../buildingSMARTLibrary/lib">
				<include name="*.jar" />
			</fileset>
			<fileset dir="../../CityGML/lib">
				<include name="*.jar" />
			</fileset>
			<fileset dir="../../O3d/lib">
				<include name="*.jar" />
			</fileset>
		</copy>
		<copy todir="builds/BuildJar/lib">
			<fileset dir="../../IFCEngine/lib">
				<include name="**" />
			</fileset>
		</copy>
		<javac srcdir="../src" destdir="builds/BuildJar/classes" debug="on" fork="true" memorymaximumsize="512m">
			<src path="../../BimServer/generated" />
			<src path="../../buildingSMARTLibrary/src" />
			<src path="../../Ifc/src" />
			<src path="../../Utils/src" />
			<src path="../../Emf/src" />
			<src path="../../Shared/src" />
			<src path="../../CityGML/src" />
			<src path="../../CityGML/src-gen" />
			<src path="../../Collada/src" />
			<src path="../../IFCEngine/src" />
			<src path="../../O3d/src" />
			<src path="../../Store/src" />
			<classpath>
				<fileset dir="builds/BuildJar/lib">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
		</javac>
		<jar jarfile="builds/BuildJar/lib/bimserver.jar" manifest="../${deploydir}/MAIN-MANIFEST.MF">
			<fileset dir="builds/BuildJar/classes" />
		</jar>
		<delete dir="builds/BuildJar/classes" />
		<javac destdir="builds/BuildJar" debug="on" srcdir="../expander" />
		<copy todir="builds/BuildJar/org/bimserver">
			<fileset dir="../expander/org/bimserver">
				<include name="*.png" />
			</fileset>
		</copy>
		<mkdir dir="builds/BuildJar/tmp" />
		<jar jarfile="builds/bimserver-${version}.jar" manifest="../${deploydir}/MANIFEST.MF">
			<fileset dir="builds/BuildJar">
				<exclude name="*.svn" />
			</fileset>
		</jar>
		<delete dir="builds/BuildJar" />
	</target>
	<target name="buildwar">
		<delete dir="builds" />
		<mkdir dir="builds" />
		<mkdir dir="builds/BuildWar" />
		<copy todir="builds/BuildWar">
			<fileset file="../deploy/shared/gpl.txt" />
		</copy>
		<mkdir dir="builds/BuildWar/WEB-INF/classes" />
		<copy todir="builds/BuildWar/">
			<fileset dir="../www" />
		</copy>
		<copy todir="builds/BuildWar/WEB-INF" overwrite="true">
			<fileset file="../deploy/shared/IFC2X3_FINAL.exp" />
			<fileset file="../deploy/shared/version.xml" />
			<fileset file="../deploy/shared/ignore.xml" />
			<fileset file="../deploy/shared/collada.xml" />
			<fileset file="../deploy/shared/_asCOBie2.xml.xsl" />
			<fileset file="../deploy/shared/_fromCOBie2.ifcxml.xsl" />
			<fileset file="../deploy/shared/_Report1.xhtml.xsl" />
			<fileset file="../${deploydir}/web.xml" />
		</copy>
		<copy file="../deploy/war/servertype.txt" todir="builds/BuildWar" />
		<copy todir="builds/BuildWar/META-INF" overwrite="true">
			<fileset file="../deploy/shared/context.xml" />
		</copy>
		<copy todir="builds/BuildWar/META-INF" overwrite="true">
			<fileset file="../deploy/war/MANIFEST.MF" />
		</copy>
		<replace file="builds/BuildWar/WEB-INF/version.xml" token="@VERSION@" value="${version}" />
		<replace file="builds/BuildWar/WEB-INF/version.xml" token="@DATE@" value="${touch.time}" />
		<replace file="builds/BuildWar/WEB-INF/web.xml" token="@VERSION@" value="${version}" />
		<copy tofile="builds/BuildWar/WEB-INF/classes/org/bimserver/ifc/emf/Ifc2x3/impl/Ifc2x3.ecore">
			<fileset file="../../Ifc/model/IFC2X3.ecore" />
		</copy>
		<copy todir="builds/BuildWar" overwrite="true">
			<fileset dir="../${deploydir}/jsp" />
		</copy>
		<copy todir="builds/BuildWar/images" overwrite="true">
			<fileset dir="../${deploydir}/images" />
		</copy>
		<copy todir="builds/BuildWar/WEB-INF/templates" overwrite="true">
			<fileset dir="../${deploydir}/templates" />
		</copy>
		<copy todir="builds/BuildWar/WEB-INF" overwrite="true">
			<fileset file="../${deploydir}/settings.xml" />
		</copy>
		<copy todir="builds/BuildWar/WEB-INF/lib" flatten="true">
			<fileset dir="../lib">
				<include name="**/*.jar"/>
				<exclude name="jetty*.jar" />
				<exclude name="jetty/*.jar" />
				<exclude name="jetty/jsp/*.jar" />
				<exclude name="ant-1.6.5.jar" />
				<exclude name="core-3.1.1.jar" />
				<exclude name="cxf/geronimo-servlet_3.0_spec-1.0.jar" />
			</fileset>
			<fileset dir="../../buildingSMARTLibrary/lib">
				<include name="*.jar" />
			</fileset>
			<fileset dir="../../CityGML/lib">
				<include name="*.jar" />
			</fileset>
			<fileset dir="../../O3d/lib">
				<include name="*.jar" />
			</fileset>
		</copy>
		<copy todir="builds/BuildWar/WEB-INF/lib">
			<fileset dir="../../IFCEngine/lib">
				<include name="**" />
			</fileset>
		</copy>
		<javac srcdir="../src" destdir="builds/BuildWar/WEB-INF/classes" debug="on" fork="true" memorymaximumsize="512m">
			<src path="../../BimServer/generated" />
			<src path="../../buildingSMARTLibrary/src" />
			<src path="../../Ifc/src" />
			<src path="../../Utils/src" />
			<src path="../../Emf/src" />
			<src path="../../Shared/src" />
			<src path="../../CityGML/src" />
			<src path="../../CityGML/src-gen" />
			<src path="../../Collada/src" />
			<src path="../../IFCEngine/src" />
			<src path="../../O3d/src" />
			<src path="../../Store/src" />
			<classpath>
				<fileset dir="builds/BuildWar/WEB-INF/lib">
					<include name="**/*.jar" />
				</fileset>
				<fileset dir="../lib/jetty">
					<include name="*.jar" />
				</fileset>
				<fileset dir="../lib/jetty/jsp">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</javac>
		<jar jarfile="builds/BuildWar/WEB-INF/lib/bimserver.jar">
			<fileset dir="builds/BuildWar/WEB-INF/classes" />
		</jar>
		<delete dir="builds/BuildWar/WEB-INF/classes" />
		<mkdir dir="builds/BuildWar/WEB-INF/classes" />
		<copy todir="builds/BuildWar/WEB-INF/classes">
			<fileset file="../${deploydir}/log4j.xml" />
		</copy>
		<jar destfile="builds/bimserver-${version}.war" manifest="../www/META-INF/MANIFEST.MF">
			<fileset dir="builds/BuildWar">
				<exclude name="*.svn" />
			</fileset>
		</jar>
		<delete dir="builds/BuildWar" />
	</target>
	<import file="one-jar-ant-task.xml" />
	<target name="buildclient">
		<delete dir="builds" />
		<mkdir dir="builds" />
		<mkdir dir="builds/BuildClient" />
		<javac srcdir="../../Client/src" destdir="builds/BuildClient/" debug="on" fork="true" memorymaximumsize="256m">
			<src path="../../Utils/src" />
			<src path="../../Shared/src" />
			<classpath>
				<fileset file="../../BimServer/lib/cxf/cxf-2.3.2.jar" />
				<fileset file="../../BimServer/lib/cxf/jsr311-api-1.1.1.jar" />
				<fileset file="../../BimServer/lib/cxf/XmlSchema-1.4.5.jar" />
				<fileset file="../../BimServer/lib/cxf/jaxb-impl-2.2.1.1.jar" />
				<fileset file="../../BimServer/lib/cxf/wsdl4j-1.6.2.jar" />
				<fileset file="../../BimServer/lib/cxf/xml-resolver-1.2.jar" />
				<fileset file="../../BimServer/lib/commons/commons-io-1.4.jar" />
				<fileset file="../../BimServer/lib/commons/commons-codec-1.3.jar" />
				<fileset file="../../BimServer/lib/mail.jar" />
				<fileset file="../../BimServer/lib/joda-time-1.6.jar" />
				<fileset file="../../BimServer/lib/logging/*.jar" />
				<fileset file="../../BimServer/lib/guava-r07.jar" />
			</classpath>
		</javac>
		<copy file="../../Client/src/org/bimserver/client/logo_small.png" todir="builds/BuildClient/org/bimserver/client" />
		<one-jar destfile="builds/bimserver-client-${version}.jar" manifest="../../BimServer/deploy/client/MANIFEST.MF">
			<main>
				<fileset dir="builds/BuildClient" />
			</main>
			<lib>
				<fileset file="../../BimServer/lib/cxf/cxf-2.3.2.jar" />
				<fileset file="../../BimServer/lib/cxf/jsr311-api-1.1.1.jar" />
				<fileset file="../../BimServer/lib/cxf/XmlSchema-1.4.5.jar" />
				<fileset file="../../BimServer/lib/cxf/jaxb-impl-2.2.1.1.jar" />
				<fileset file="../../BimServer/lib/cxf/wsdl4j-1.6.2.jar" />
				<fileset file="../../BimServer/lib/cxf/xml-resolver-1.2.jar" />
				<fileset file="../../BimServer/lib/commons/commons-io-1.4.jar" />
				<fileset file="../../BimServer/lib/commons/commons-codec-1.3.jar" />
				<fileset file="../../BimServer/lib/mail.jar" />
				<fileset file="../../BimServer/lib/joda-time-1.6.jar" />
				<fileset file="../../BimServer/lib/logging/*.jar" />
				<fileset file="../../BimServer/lib/guava-r07.jar" />
			</lib>
		</one-jar>
		<delete dir="builds/BuildClient" />
	</target>
	<target name="buildsource">
		<delete dir="builds" />
		<mkdir dir="builds" />
		<mkdir dir="builds/BuildSource" />
		<mkdir dir="builds/BuildSource/BIMserver" />
		<copy todir="builds/BuildSource/BIMserver/Bimserver">
			<fileset dir="../../BimServer" />
		</copy>
		<copy todir="builds/BuildSource/BIMserver/buildingSMARTLibrary">
			<fileset dir="../../buildingSMARTLibrary" />
		</copy>
		<copy todir="builds/BuildSource/BIMserver/CityGML">
			<fileset dir="../../CityGML" />
		</copy>
		<copy todir="builds/BuildSource/BIMserver/Client">
			<fileset dir="../../Client" />
		</copy>
		<copy todir="builds/BuildSource/BIMserver/Collada">
			<fileset dir="../../Collada" />
		</copy>
		<copy todir="builds/BuildSource/BIMserver/Emf">
			<fileset dir="../../Emf" />
		</copy>
		<copy todir="builds/BuildSource/BIMserver/Ifc">
			<fileset dir="../../Ifc" />
		</copy>
		<copy todir="builds/BuildSource/BIMserver/IFCEngine">
			<fileset dir="../../IFCEngine" />
		</copy>
		<copy todir="builds/BuildSource/BIMserver/O3d">
			<fileset dir="../../O3d" />
		</copy>
		<copy todir="builds/BuildSource/BIMserver/Shared">
			<fileset dir="../../Shared" />
		</copy>
		<copy todir="builds/BuildSource/BIMserver/Store">
			<fileset dir="../../Store" />
		</copy>
		<copy todir="builds/BuildSource/BIMserver/Tests">
			<fileset dir="../../Tests" />
		</copy>
		<copy todir="builds/BuildSource/BIMserver/Utils">
			<fileset dir="../../Utils" />
		</copy>
		<copy todir="builds/BuildSource/BIMserver/TestData">
			<fileset dir="../../TestData" />
		</copy>
		<zip file="builds/bimserver-source-${version}.zip" basedir="builds/BuildSource" />
		<delete dir="builds/BuildSource" />
	</target>
</project>