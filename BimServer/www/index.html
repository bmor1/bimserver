<!DOCTYPE html>
<html>
	<head>
		<link href="css/bootstrap.min.css" rel="stylesheet">
		<link href="css/main.css" rel="stylesheet">
		<script src="js/jquery-1.8.2.min.js"></script>
		<script src="js/bimserverapi.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/jquery.cookie.js"></script>
		<script src="js/String.js"></script>
		<script src="js/formatters.js"></script>
		<script src="js/sha256.js"></script>
	</head>
	<body>
		<div class="row-fluid show-grid">
              <div class="span4"></div>
              <div class="span4">
					<img src="img/logo.gif"/>
              		<div class="status alert alert-block"></div>
              		<div class="indexcontainer">
					</div>
              </div>
              <div class="span4"></div>
        </div>
	</body>
	<script>
		var bimServerApi = null;

		function updateStatus() {
			bimServerApi.multiCall([
   				["ServiceInterface", "getServerInfo", {}],
   				["ServiceInterface", "getVersion", {}]
   			], function(data){
   				var infoDiv = $("<table class=\"table\">");
   				var serverInfo = data[0].result;
   				if (serverInfo.serverState == "NOT_SETUP") {
   					$(".indexcontainer").load("setup.html", function(){
   						new Setup(address);
   					});
   				} else {
   					infoDiv.append("<tr><td>Status</td><td>" + serverInfo.serverState + "</td></tr>");
   				}
   				var version = data[1].result;
   				infoDiv.append("<tr><td>Version</td><td>" + version.major + "." + version.minor + "." + version.revision + " (" + formatDate(new Date(version.date)) + ")</td></tr>");
   				$(".indexcontainer").html(infoDiv);
   			});
		}

		$(function(){
			var loc = new String(document.location);
			var address = loc.substring(0, loc.length-1);
			
			var notifier = {
				error: function(message){
					$(".genericErrors .text").html(message).parent().show();
				},
				info: function(message) {
					$(".genericErrors .text").html(message).parent().show();
				},
				clear: function() {
					$(".genericErrors .text").html("").parent().hide();
				},
				resetStatus: function(){
					$(".status").stop(true, true);
					$(".status").fadeOut(1000);
				},
				resetStatusQuick: function(){
					$(".status").hide();
				},
				setStatus: function(status, timeToShow) {
					if (timeToShow == null) {
						timeToShow = 5000;
					}
					$(".status").stop(true, true);
					if (this.lastTimeOut != null) {
						clearTimeout(this.lastTimeOut);
						this.lastTimeOut = null;
					}
					$(".status").show().html(status).removeClass("error-error");
					var notifier = this;
					if (timeToShow != -1) {
						this.lastTimeOut = setTimeout(function(){
							notifier.resetStatus();
						}, timeToShow);
					}
				},
				setError: function(error) {
					$(".status").html(error).addClass("error-error").show();
				}
			};
			
			bimServerApi = new BimServerApi(address, notifier);
			
			bimServerApi.call("ServiceInterface", "getServerInfo", {}, function(serverInfo){
				if (serverInfo.serverState == "NOT_SETUP") {
					$(".indexcontainer").load("setup.html", function(){
						new Setup(address);
					});
				} else {
					updateStatus();
				}
			});
		});
	</script>
</html>